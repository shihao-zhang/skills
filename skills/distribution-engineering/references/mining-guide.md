# 数据挖掘方法论

从原始对话日志中提取结构化信息，填充 dist_core schema。

## 挖掘前准备

### 数据预处理

1. **噪声剔除**：识别并移除纯闲聊、内部沟通、测试数据
2. **角色分离**：区分 Agent 发言（学习目标）与 User 发言（模拟对象）
3. **PII 脱敏**：手机号、姓名、身份证等替换为占位符
4. **会话切分**：按 session_id 或时间间隔切分独立对话

### 数据质量评估

- 样本总量是否足够（建议 500+ 条完整对话）
- 场景覆盖是否均衡（避免单一场景占比过高）
- 时间跨度是否合理（避免季节性偏差）

---

## 四维挖掘框架

### 1. Entity Mining → pools

**目标**：发现业务实体，填充 `pools`

**方法**：
- 名词短语提取（NER / 规则匹配）
- 频次统计，识别高频实体
- 语义聚类，合并同义表达
- 识别长尾实体，标注 `EXPERT` 来源

**关注点**：
- 核心业务对象（产品、地点、人物）
- 属性值（价格区间、等级、状态）
- 错误/异常类型

**输出格式**：
```json
{
  "pool_name": {
    "type": "text",
    "values": ["值1", "值2", ...],
    "frequency": [120, 85, ...],
    "source": "MINED"
  }
}
```

---

### 2. Intent Mining → scenarios

**目标**：发现意图链路，构建 `scenarios` 骨架

**方法**：
- 对话开场语分类（识别用户初始意图）
- 意图转移分析（A→B→C 链路统计）
- 槽位共现分析（哪些信息通常一起出现）
- 异常路径标注（失败、放弃、转人工）

**关注点**：
- 高频意图组合（正常流程）
- 低频但重要的异常路径
- 意图歧义情况（同一表达多种理解）

**输出格式**：
```json
{
  "intent_chain": ["QUERY", "CLARIFY", "CONFIRM", "COMPLETE"],
  "frequency": 230,
  "typical_slots": ["destination", "date", "budget"],
  "failure_rate": 0.12
}
```

---

### 3. Trait Mining → personas

**目标**：发现用户特征模式，构建 `personas`

**分析维度**：

| 维度 | 指标 | 聚类依据 |
|------|------|----------|
| 表达风格 | 平均字数、标点使用、表情符号 | 简洁型 / 啰嗦型 |
| 交互节奏 | 回复间隔、追问次数 | 急躁型 / 耐心型 |
| 信息完整度 | 首轮信息量、被动补充比例 | 主动型 / 挤牙膏型 |
| 情感倾向 | 情感词频、语气词使用 | 理性型 / 情绪型 |
| 决策模式 | 确认轮数、比较请求 | 果断型 / 犹豫型 |

**输出格式**：
```json
{
  "cluster_id": "C1",
  "tag": "焦虑挤牙膏型",
  "sample_count": 156,
  "features": {
    "avg_msg_length": 12,
    "clarify_rounds": 2.3,
    "emotion_words_ratio": 0.15
  },
  "representative_quotes": ["急死了", "怎么还没好"]
}
```

---

### 4. Context Inpainting → context / perturbations

**目标**：补全对话中隐含的背景信息

**方法**：LLM 反推

**Prompt 模板**：
```
以下是一段客服对话片段：
---
{conversation_snippet}
---

请分析并推断：
1. 用户的隐藏动机是什么？（为什么现在问这个问题）
2. 用户当前的环境背景（时间压力、场所、设备限制等）
3. 用户可能没说出口的顾虑
4. 这段对话中出现了哪些"意外情况"或"扰动"

以 JSON 格式输出。
```

**输出格式**：
```json
{
  "hidden_motive": "担心错过航班，必须今天确认住宿",
  "context": "在机场候机，时间紧迫，网络不稳定",
  "unspoken_concerns": ["预算有限但不好意思直说", "对平台不太信任"],
  "perturbations_observed": ["中途突然发截图", "前后信息矛盾"]
}
```

---

## 挖掘报告模板

```markdown
# 数据挖掘报告 - {project_name}

## 数据概览
- 原始对话数：XXX
- 有效对话数：XXX（过滤后）
- 时间范围：YYYY-MM-DD ~ YYYY-MM-DD

## Entity Mining 结果
### 高频实体池
| 池名 | Top 5 值 | 总类别数 | 来源 |
|------|----------|----------|------|
| destination | 新加坡, 普吉岛, ... | 23 | MINED |

### 建议补充（长尾/Corner Case）
- ...

## Intent Mining 结果
### 主要意图链路
1. QUERY → CONFIRM → COMPLETE (45%)
2. QUERY → CLARIFY → QUERY → COMPLETE (30%)
3. ...

### 异常路径
- QUERY → ERROR → ESCALATE (8%)

## Trait Mining 结果
### 用户聚类
| Cluster | Tag | 占比 | 典型特征 |
|---------|-----|------|----------|
| C1 | 焦虑挤牙膏 | 35% | 短句、催促、信息不全 |

## Context Inpainting 发现
### 常见隐藏背景
- 时间压力类：...
- 信任顾虑类：...

### 高频扰动类型
- 信息不全
- 突发截图
- ...

## dist_core 填充建议
[JSON 代码块]
```

---

## 注意事项

1. **挖掘不是终点**：挖掘结果需要人工 review，补充专家知识
2. **避免过拟合**：高频不等于全部，刻意保留长尾
3. **迭代优化**：随着新数据积累，定期重新挖掘
