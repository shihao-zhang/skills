# 分布管理检查清单

生成配方后，使用此清单评估数据分布质量。

---

## 1. 语义覆盖度

### 表达多样性
- [ ] 同一意图是否有多种问法（直接/委婉/口语/书面）
- [ ] 是否包含模糊表达（"便宜点的"、"好一点的"）
- [ ] 是否包含否定/反问句式
- [ ] 是否覆盖不同语气（礼貌/急躁/随意）

### 实体多样性
- [ ] 每个 pool 的值是否足够丰富（建议 10+）
- [ ] 高频值与长尾值是否都有覆盖
- [ ] 是否包含边界值/异常值

### 检查方法
```
统计每个 pool 在样本中的值分布
计算香农熵，熵值过低说明分布过于集中
```

---

## 2. 槽位分布均衡性

### 必填槽位
- [ ] 每个必填槽位的填充率是否符合 `fill_required_prob` 设定
- [ ] 缺失情况是否有对应的追问训练样本

### 可选槽位
- [ ] 可选槽位是否有"提供"和"不提供"两种情况
- [ ] 槽位值的分布是否与 pool weight 一致

### 槽位组合
- [ ] 是否有槽位共现的多种组合（不只是固定搭配）
- [ ] 前后矛盾的情况是否按 `contradiction_prob` 注入

### 检查方法
```
统计每个槽位的：
- 填充率
- 值分布（对比 pool weight）
- 与其他槽位的共现矩阵
```

---

## 3. 工作流完整性

### 正常流程
- [ ] Happy path 是否充分覆盖
- [ ] 不同轮数的对话是否按 `turns` 配置分布

### 异常流程
- [ ] 工具调用失败（tool_fail）
- [ ] 信息缺失需追问（missing_info）
- [ ] 用户超出业务范围（out_of_scope）
- [ ] 用户信息前后矛盾（contradiction）

### 边界情况
- [ ] 用户中途放弃
- [ ] 用户情绪激动需安抚
- [ ] 需要转人工的情况
- [ ] 用户插入无关话题

### 检查方法
```
统计样本中各流程类型的占比
与 sampling.negatives 配置对比
```

---

## 4. Persona 覆盖度

### 数量平衡
- [ ] 每个 persona 的样本量是否符合 mix 配比
- [ ] 是否有 persona 被遗漏

### 特征一致性
- [ ] 生成的对话是否体现 persona 的 style
- [ ] behavior_rules 是否在对话中有所体现
- [ ] slot_bias 是否影响了槽位值的选择

### 检查方法
```
抽样检查：每个 persona 随机抽 10 条
人工评估是否"像"这个角色
```

---

## 5. 成本与效率

### Token 预算
- [ ] 单样本 token 数是否在 `max_tokens_per_sample` 内
- [ ] 总成本是否在 `max_usd_total` 内

### 冗余检查
- [ ] 是否有高度相似的重复样本
- [ ] 是否有无效样本（对话断裂、格式错误）

---

## 检查报告模板

```markdown
# 分布质量检查报告

## 基本信息
- Recipe: {recipe_name}
- 样本总数: {count}
- 检查时间: {timestamp}

## 检查结果

### 语义覆盖度
| 检查项 | 状态 | 备注 |
|--------|------|------|
| 表达多样性 | ✅/⚠️/❌ | |
| 实体多样性 | ✅/⚠️/❌ | |

### 槽位分布
| 槽位 | 预期填充率 | 实际填充率 | 状态 |
|------|-----------|-----------|------|
| destination | 85% | 82% | ✅ |

### 工作流覆盖
| 流程类型 | 预期占比 | 实际占比 | 状态 |
|----------|---------|---------|------|
| normal | 85% | 83% | ✅ |
| negative | 15% | 17% | ✅ |

### Persona 分布
| Persona | 预期占比 | 实际占比 | 抽样评分 |
|---------|---------|---------|---------|
| p_tech_weak_anxious | 30% | 29% | 4.2/5 |

## 总结
- 通过项: X/Y
- 需关注: ...
- 建议调整: ...
```

---

## 常见问题与修复

| 问题 | 可能原因 | 修复方式 |
|------|----------|----------|
| 某实体值占比过高 | pool weight 设置不当 | 调整 weight 或增加值 |
| 对话轮数分布偏离 | turns 配置与场景不匹配 | 调整 turns 或场景复杂度 |
| Persona 特征不明显 | style 描述太模糊 | 增加具体的语言示例 |
| 负样本不自然 | injection_hint 不够具体 | 补充更详细的注入说明 |
